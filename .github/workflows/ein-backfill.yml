name: eInnsyn backfill statsforvalteren

on:
  workflow_dispatch: {}

jobs:
  backfill:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        startWeek: [
          0, 4, 8, 12, 16, 20, 24, 28,
          32, 36, 40, 44, 48, 52, 56, 60,
          64, 68, 72, 76, 80, 84, 88, 92,
          96, 100, 104, 108, 112, 116, 120, 124,
          128, 132, 136, 140, 144, 148, 152, 156,
          160, 164, 168, 172, 176, 180, 184, 188,
          192, 196, 200, 204
        ]

    steps:
      - name: Call Supabase function for a 4-week chunk
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          set -euo pipefail
          echo "Backfill chunk startWeek=${{ matrix.startWeek }}"

          URL="https://$SUPABASE_PROJECT_ID.functions.supabase.co/ein_result_backfill?yearsBack=4&weeks=4&startWeek=${{ matrix.startWeek }}&size=50&maxPages=200"

          echo "Kaller: $URL"

          # Kj√∏r curl, men fang opp HTTP-koden og body
          HTTP_CODE=$(curl -sS -o /tmp/resp.json -w "%{http_code}" -X POST "$URL")

          echo "HTTP-kode: $HTTP_CODE"
          echo "Respons:"
          cat /tmp/resp.json || true
          echo

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Backfill-feil for startWeek=${{ matrix.startWeek }} (HTTP $HTTP_CODE)"
            exit 1
          fi
