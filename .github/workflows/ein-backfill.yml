name: eInnsyn backfill statsforvalteren

on:
  workflow_dispatch: {}  # kjør manuelt fra GitHub UI

jobs:
  backfill:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      # Hver "chunk" tar 4 uker
      # 0,4,8,...,204 dekker ca. 4 år (52 * 4 uker)
      matrix:
        startWeek: [
          0, 4, 8, 12, 16, 20, 24, 28,
          32, 36, 40, 44, 48, 52, 56, 60,
          64, 68, 72, 76, 80, 84, 88, 92,
          96, 100, 104, 108, 112, 116, 120, 124,
          128, 132, 136, 140, 144, 148, 152, 156,
          160, 164, 168, 172, 176, 180, 184, 188,
          192, 196, 200, 204
        ]

    steps:
      - name: Call Supabase function for a 4-week chunk
        env:
          SUPABASE_FUNCTIONS_BASE: ${{ secrets.SUPABASE_FUNCTIONS_BASE }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          echo "Backfill chunk startWeek=${{ matrix.startWeek }}"
          URL="$SUPABASE_FUNCTIONS_BASE/ein_result_backfill?yearsBack=4&weeks=4&startWeek=${{ matrix.startWeek }}&size=50&maxPages=200"
          echo "Kaller: $URL"

          curl -fSs -X POST \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$URL"
