name: Nightly scrapers

on:
  schedule:
    - cron: "0 1 * * *"   # 01:00 UTC = 02:00 norsk tid
  workflow_dispatch:

env:
  SUPABASE_URL: https://votycqayjxathlonvddk.supabase.co
  FUNCTIONS_PATH: /functions/v1

jobs:
  batch_collect:
    runs-on: ubuntu-latest
    steps:
      - name: Kick off collectors
        env:
          SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          call() {
            fn="$1"
            url="${SUPABASE_URL}${FUNCTIONS_PATH}/${fn}"
            echo "→ POST $url"

            # 3 forsøk med 30s pause
            for i in 1 2 3; do
              # -i for headers i responsen
              # --fail-with-body for å få med feilmelding ved 4xx 5xx
              # -w for å skrive HTTP-kode på slutten
              http=$(curl -sS -i --fail-with-body -X POST "$url" \
                -H "Authorization: Bearer $SRK" \
                -H "apikey: $SRK" \
                -H "Content-Type: application/json" \
                -d '{}' \
                -w '%{http_code}' -o /tmp/curl_body)

              code="$http"
              echo ""
              echo "Status: $code"
              echo "Body:"
              cat /tmp/curl_body || true
              echo ""

              if [ "$code" = "200" ] || [ "$code" = "204" ]; then
                echo "✓ $fn ok"
                break
              else
                echo "✗ $fn failed attempt $i"
                if [ "$i" -lt 3 ]; then sleep 30; else exit 1; fi
              fi
            done
          }

          call hnt_postliste
          call hmn_postliste
          call scrape_nord
          call kommunale_postlister

  batch_parse:
    needs: batch_collect
    runs-on: ubuntu-latest
    steps:
      - name: Wait 5 minutes
        run: sleep 300
      - name: Run parsers
        env:
          SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_URL: https://votycqayjxathlonvddk.supabase.co
          FUNCTIONS_PATH: /functions/v1
        run: |
          set -euo pipefail
          call() {
            fn="$1"
            url="${SUPABASE_URL}${FUNCTIONS_PATH}/${fn}"
            echo "→ POST $url"
            for i in 1 2 3; do
              http=$(curl -sS -i --fail-with-body -X POST "$url" \
                -H "Authorization: Bearer $SRK" \
                -H "apikey: $SRK" \
                -H "Content-Type: application/json" \
                -d '{}' \
                -w '%{http_code}' -o /tmp/curl_body)
              echo ""
              echo "Status: $http"
              echo "Body:"
              cat /tmp/curl_body || true
              echo ""
              if [ "$http" = "200" ] || [ "$http" = "204" ]; then
                echo "✓ $fn ok"; break
              else
                echo "✗ $fn failed attempt $i"
                if [ "$i" -lt 3 ]; then sleep 30; else exit 1; fi
              fi
            done
          }
          call hnt_parse
          call nord_parse