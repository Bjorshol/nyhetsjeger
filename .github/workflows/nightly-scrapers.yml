name: Nightly scrapers

on:
  schedule:
    - cron: "0 1 * * *"   # 01:00 UTC = 02:00 vinter / 03:00 sommer i Oslo
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  ANON: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

jobs:
  batch_collect:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        fn: [hnt_postliste, hmn_postliste, scrape_nord, kommunale_postlister]

    steps:
      - name: Derive project ref and functions base
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          test -n "${SUPABASE_URL:-}" || { echo "SUPABASE_URL missing"; exit 1; }
          REF=$(echo "$SUPABASE_URL" | sed -E 's#^https?://([^.]+)\.supabase\.co.*#\1#')
          echo "functions_base=https://$REF.functions.supabase.co" >> "$GITHUB_OUTPUT"
          echo "Using project ref: $REF"
          HOST=$(echo "$SUPABASE_URL" | sed -E 's#https?://([^/]+)/?.*#\1#')
          echo "Resolving $HOST ..."; getent hosts "$HOST" || { echo "DNS lookup failed for $HOST"; exit 1; }

      - name: Call ${{ matrix.fn }}
        shell: bash
        env:
          FUNCTIONS_BASE: ${{ steps.derive.outputs.functions_base }}
        run: |
          set -euo pipefail
          url="${FUNCTIONS_BASE}/${{ matrix.fn }}"
          echo "→ POST $url"

          # Preflight: 404 = feil navn/deploy, 401/403 = auth, 405 = ok domene
          code_head=$(curl -sS -i -X OPTIONS "$url" -w '%{http_code}' -o /tmp/pre || true)
          echo "Preflight status: $code_head"; tail -c 800 /tmp/pre || true; echo

          for i in 1 2 3; do
            code=$(curl -sS -i --fail-with-body -X POST "$url" \
              -H "Authorization: Bearer $ANON" \
              -H "apikey: $ANON" \
              -H "Content-Type: application/json" \
              --data '{"reason":"github-schedule"}' \
              -w '%{http_code}' -o /tmp/body) || true

            echo -e "\nHTTP: $code"; tail -c 3000 /tmp/body || true; echo
            if [ "$code" = "200" ] || [ "$code" = "204" ]; then echo "✓ ${{ matrix.fn }} ok"; break; fi
            echo "✗ attempt $i"; if [ "$i" -lt 3 ]; then sleep 25; else exit 1; fi
          done

  batch_parse:
    needs: batch_collect
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        fn: [hnt_parse, nord_parse]

    steps:
      - name: Derive project ref and functions base
        id: derive
        shell: bash
        run: |
          set -euo pipefail
          REF=$(echo "$SUPABASE_URL" | sed -E 's#^https?://([^.]+)\.supabase\.co.*#\1#')
          echo "functions_base=https://$REF.functions.supabase.co" >> "$GITHUB_OUTPUT"
          echo "Using project ref: $REF"

      - name: Wait a bit for collectors
        run: sleep 300

      - name: Call ${{ matrix.fn }}
        shell: bash
        env:
          FUNCTIONS_BASE: ${{ steps.derive.outputs.functions_base }}
        run: |
          set -euo pipefail
          url="${FUNCTIONS_BASE}/${{ matrix.fn }}"
          echo "→ POST $url"
          for i in 1 2 3; do
            code=$(curl -sS -i --fail-with-body -X POST "$url" \
              -H "Authorization: Bearer $ANON" \
              -H "apikey: $ANON" \
              -H "Content-Type: application/json" \
              --data '{"reason":"github-schedule"}' \
              -w '%{http_code}' -o /tmp/body) || true

            echo -e "\nHTTP: $code"; tail -c 3000 /tmp/body || true; echo
            if [ "$code" = "200" ] || [ "$code" = "204" ]; then echo "✓ ${{ matrix.fn }} ok"; break; fi
            echo "✗ attempt $i"; if [ "$i" -lt 3 ]; then sleep 25; else exit 1; fi
          done
