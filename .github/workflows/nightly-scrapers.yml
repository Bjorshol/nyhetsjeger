name: Nightly scrapers

on:
  schedule:
    - cron: "0 1 * * *"   # 01:00 UTC = 02:00 norsk tid
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}           # f.eks. https://abcdeftghijklm.supabase.co
  FUNCTIONS_PATH: /functions/v1
  SRK: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  batch_collect:
    runs-on: ubuntu-latest
    steps:
      - name: Sanity check Supabase URL (DNS)
        run: |
          set -e
          if [ -z "${SUPABASE_URL:-}" ]; then
            echo "SUPABASE_URL is empty. Set repo secret SUPABASE_URL to your Project URL"; exit 1
          fi
          echo "Using $SUPABASE_URL"
          host=$(echo "$SUPABASE_URL" | sed -E 's#https?://([^/]+)/?.*#\1#')
          echo "Resolving $host ..."
          getent hosts "$host" || { echo "DNS lookup failed for $host"; exit 1; }

      - name: Kick off collectors
        shell: bash
        run: |
          set -euo pipefail

          call() {
            fn="$1"
            url="${SUPABASE_URL}${FUNCTIONS_PATH}/${fn}"
            echo "→ POST $url"

            for i in 1 2 3; do
              http=$(curl -sS -i --fail-with-body -X POST "$url" \
                -H "Authorization: Bearer $SRK" \
                -H "apikey: $SRK" \
                -H "Content-Type: application/json" \
                -d '{}' \
                -w '%{http_code}' -o /tmp/curl_body) || true

              echo
              echo "Status: $http"
              echo "Body:"; cat /tmp/curl_body || true; echo

              if [ "$http" = "200" ] || [ "$http" = "204" ]; then
                echo "✓ $fn ok"; break
              else
                echo "✗ $fn failed attempt $i"
                if [ "$i" -lt 3 ]; then sleep 30; else exit 1; fi
              fi
            done
          }

          call hnt_postliste
          call hmn_postliste
          call scrape_nord
          call kommunale_postlister

  batch_parse:
    needs: batch_collect
    runs-on: ubuntu-latest
    steps:
      - name: Wait 5 minutes
        run: sleep 300

      - name: Run parsers
        shell: bash
        run: |
          set -euo pipefail
          call() {
            fn="$1"
            url="${SUPABASE_URL}${FUNCTIONS_PATH}/${fn}"
            echo "→ POST $url"
            for i in 1 2 3; do
              http=$(curl -sS -i --fail-with-body -X POST "$url" \
                -H "Authorization: Bearer $SRK" \
                -H "apikey: $SRK" \
                -H "Content-Type: application/json" \
                -d '{}' \
                -w '%{http_code}' -o /tmp/curl_body) || true
              echo
              echo "Status: $http"
              echo "Body:"; cat /tmp/curl_body || true; echo
              if [ "$http" = "200" ] || [ "$http" = "204" ]; then
                echo "✓ $fn ok"; break
              else
                echo "✗ $fn failed attempt $i"
                if [ "$i" -lt 3 ]; then sleep 30; else exit 1; fi
              fi
            done
          }
          call hnt_parse
          call nord_parse
